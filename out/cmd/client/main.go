// Package main is originally generated by trpc-cmdline v1.0.9.
// It is located at `project/cmd/client`.
// Run this file by executing `go run cmd/client/main.go` in the project directory.
package main

import (
	pb "trpc-go-example/trpc/example/storage"

	_ "trpc.group/trpc-go/trpc-database/goredis"
	_ "trpc.group/trpc-go/trpc-database/kafka"
	_ "trpc.group/trpc-go/trpc-database/mongodb"
	_ "trpc.group/trpc-go/trpc-database/mysql"
	_ "trpc.group/trpc-go/trpc-filter/debuglog"
	trpc "trpc.group/trpc-go/trpc-go"
	"trpc.group/trpc-go/trpc-go/client"
	"trpc.group/trpc-go/trpc-go/log"
)

func callStorageServiceStore(k string, v string) {
	proxy := pb.NewStorageServiceClientProxy(
		client.WithTarget("ip://127.0.0.1:8000"),
		client.WithProtocol("trpc"),
	)
	ctx := trpc.BackgroundContext()
	// Example usage of unary client.
	reply, err := proxy.Store(ctx, &pb.StoreRequest{Key: k, Value: v})
	if err != nil {
		log.Fatalf("err: %v", err)
	}
	log.Debugf("simple  rpc   receive: %+v", reply)
}

func callStorageServiceFetch(k string) {
	proxy := pb.NewStorageServiceClientProxy(
		client.WithTarget("ip://127.0.0.1:8000"),
		client.WithProtocol("trpc"),
	)
	ctx := trpc.BackgroundContext()
	// Example usage of unary client.
	reply, err := proxy.Fetch(ctx, &pb.FetchRequest{Key: k})
	if err != nil {
		log.Fatalf("err: %v", err)
	}
	log.Debugf("simple  rpc   receive: %+v", reply.GetValue())
}

func main() {
	// Load configuration following the logic in trpc.NewServer.
	cfg, err := trpc.LoadConfig(trpc.ServerConfigPath)
	if err != nil {
		panic("load config fail: " + err.Error())
	}
	trpc.SetGlobalConfig(cfg)
	if err := trpc.Setup(cfg); err != nil {
		panic("setup plugin fail: " + err.Error())
	}
	callStorageServiceStore("Mongo", "done")
	callStorageServiceFetch("Mongo")
}
